<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Microservices Architecture Scene</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
    <script>
      AFRAME.registerComponent('start-button', {
        init: function () {
          this.el.addEventListener('click', function () {
            this.emit('start-data-flow');
          });
        }
      });

      AFRAME.registerComponent('pause-button', {
        init: function () {
          this.el.addEventListener('click', function () {
            var vis = document.querySelector('[microservices-visualization]').components['microservices-visualization'];
            vis.isPaused = !vis.isPaused;
            this.setAttribute('text', 'value', vis.isPaused ? 'Resume' : 'Pause');
            if (!vis.isPaused) vis.animateNextStep();
          });
        }
      });

      AFRAME.registerComponent('open-article', {
        init: function () {
          this.el.addEventListener('click', function () {
            window.open('https://dev.to/charity_everett/introduction-to-microservices-architecture-with-docker-and-kubernetes-3el8', '_blank');
          });
        }
      });

      AFRAME.registerComponent('service-interaction', {
        init: function () {
          this.el.addEventListener('click', function () {
            console.log('Service clicked:', this.id);
          });
        }
      });

      AFRAME.registerComponent('microservices-visualization', {
        init: function () {
          this.services = {
            client: this.el.querySelector('#client'),
            apiGateway: this.el.querySelector('#apiGateway'),
            authService: this.el.querySelector('#authService'),
            userService: this.el.querySelector('#userService'),
            productService: this.el.querySelector('#productService'),
            orderService: this.el.querySelector('#orderService'),
            paymentService: this.el.querySelector('#paymentService')
          };

          this.dataFlow = [
            { from: 'client', to: 'apiGateway', data: { action: "place_order", user_id: "12345", product_id: "67890", quantity: 2 } },
            { from: 'apiGateway', to: 'authService', data: { action: "authenticate", user_id: "12345", auth_token: "abcdef" } },
            { from: 'authService', to: 'apiGateway', data: { user_id: "12345", authenticated: true } },
            { from: 'apiGateway', to: 'userService', data: { action: "get_user_info", user_id: "12345" } },
            { from: 'userService', to: 'apiGateway', data: { user_id: "12345", address: "123 Main St", preferred_payment: "credit_card" } },
            { from: 'apiGateway', to: 'productService', data: { action: "check_product_availability", product_id: "67890", quantity: 2 } },
            { from: 'productService', to: 'apiGateway', data: { product_id: "67890", available: true, stock: 10 } },
            { from: 'apiGateway', to: 'orderService', data: { action: "create_order", user_id: "12345", product_id: "67890", quantity: 2, address: "123 Main St", payment: "credit_card" } },
            { from: 'orderService', to: 'apiGateway', data: { order_id: "A123", status: "pending_payment" } },
            { from: 'orderService', to: 'paymentService', data: { action: "process_payment", order_id: "A123", amount: 100.00, payment_method: "credit_card" } },
            { from: 'paymentService', to: 'orderService', data: { payment_status: "success", transaction_id: "TXN789" } },
            { from: 'orderService', to: 'apiGateway', data: { order_id: "A123", status: "completed" } },
            { from: 'apiGateway', to: 'client', data: { order_id: "A123", status: "completed", message: "Your order has been successfully placed!" } }
          ];

          this.currentStep = 0;
          this.isPaused = false;

          this.el.sceneEl.addEventListener('start-data-flow', this.startDataFlow.bind(this));
        },

        startDataFlow: function () {
          this.animateNextStep();
        },

        animateNextStep: function () {
          if (this.isPaused || this.currentStep >= this.dataFlow.length) return;

          var step = this.dataFlow[this.currentStep];
          var fromEl = this.services[step.from];
          var toEl = this.services[step.to];

          var dataEl = document.createElement('a-sphere');
          dataEl.setAttribute('radius', '0.1');
          dataEl.setAttribute('color', 'yellow');
          dataEl.setAttribute('position', fromEl.getAttribute('position'));

          dataEl.setAttribute('animation', {
            property: 'position',
            to: toEl.getAttribute('position'),
            dur: 2000,
            easing: 'linear'
          });

          this.el.appendChild(dataEl);

          setTimeout(() => {
            this.el.removeChild(dataEl);
            this.currentStep++;
            this.animateNextStep();
          }, 2000);

          this.updateInfoPanel(step.data);
        },

        updateInfoPanel: function (data) {
          var infoPanel = document.querySelector('#infoPanel');
          infoPanel.setAttribute('text', {
            value: JSON.stringify(data, null, 2),
            width: 2
          });
        },

        pause: function () {
          this.isPaused = true;
        },

        resume: function () {
          this.isPaused = false;
          this.animateNextStep();
        },

        reset: function () {
          this.currentStep = 0;
          this.isPaused = false;
          var infoPanel = document.querySelector('#infoPanel');
          infoPanel.setAttribute('text', {
            value: 'Data flow reset. Click Start to begin.',
            width: 2
          });
        }
      });
    </script>
  </head>
  <body>
    <a-scene>
      <a-assets>
        <img id="sky" crossorigin="anonymous" src="https://cdn.glitch.global/5cfc02c2-e08f-4e29-9383-05c3fa57335f/Microservice%20Skybox.png?v=1729023719252">
        <img id="article-preview" crossorigin="anonymous" src="https://cdn.glitch.global/5cfc02c2-e08f-4e29-9383-05c3fa57335f/MicroservicesPage.png?v=1729025756305">
        <img id="shippingcontainertexture" crossorigin="anonymous" src="https://cdn.glitch.global/5cfc02c2-e08f-4e29-9383-05c3fa57335f/shippingcontainertexture.png?v=1729534098043">      </a-assets>

      <a-sky src="#sky"></a-sky>
      
      <a-entity position="0 1.6 4" rotation="0 180 0">
        <a-plane width="8" height="6" color="#CCC">
          <a-plane position="0 0 0.01" width="7.8" height="5.8" src="#article-preview" open-article></a-plane>
          <a-text value="Click to read full article" align="center" position="0 -2.9 0.1" width="8" color="#000"></a-text>
        </a-plane>
      </a-entity>

      <!-- Microservices Architecture Viz -->
<a-entity microservices-visualization position="0 1.726 -3" scale=".75 .75 .75">
    <!-- Microservices Architecture Title -->
<a-text value="Microservices Architecture" position="0 3.5 -2" align="center" color="#00CED1" scale="3 3 3" font="https://cdn.aframe.io/fonts/mozillavr.fnt"></a-text>

<!-- Client -->
<a-box id="client" position="0 2.15 0.25" depth="1.2" height="0.4" width="0.6"
       material="color: #D2691E; src: #shippingcontainertexture"
       rotation="15 30 15" service-interaction="name: client"></a-box>
<a-text value="Client" position="0 2.3 0.5" align="center" rotation="-15 30 0" scale="0.5 0.5 0.5"></a-text>

<!-- API Gateway -->
<a-box id="apiGateway" position="0 1.5 0" depth="1.2" height="0.4" width="0.6"
       material="color: #808080; src: #shippingcontainertexture"
       rotation="15 30 15" service-interaction="name: api-gateway"></a-box>
<a-text value="API Gateway" position="0 1.8 0.5" align="center" rotation="-15 30 0" scale="0.5 0.5 0.5"></a-text>
 
<!-- Authentication Service -->
<a-box id="authService" position="-2 1 0" depth="1.2" height="0.4" width="0.6"
       material="color: #D2691E; src: #shippingcontainertexture"
       rotation="15 30 15" service-interaction="name: auth-service"></a-box>
<a-text value="Authentication Service" position="-2 1.3 0.5" align="center"
        rotation="-15 30 0" scale="0.5 0.5 0.5"></a-text>

<!-- User Service -->
<a-box id="userService" position="-1 1 0" depth="1.2" height="0.4" width="0.6"
       material="color: #D2691E; src: #shippingcontainertexture"
       rotation="15 30 15" service-interaction="name: user-service"></a-box>
<a-text value="User Service" position="-1 1.3 0.5" align="center"
        rotation="-15 30 0" scale="0.5 0.5 0.5"></a-text>
  
 <!-- Product Service -->
<a-box id="productService" position="1 1 0" depth="1.2" height="0.4" width="0.6"
       material="color: #D2691E; src: #shippingcontainertexture"
       rotation="15 30 15" service-interaction="name: product-service"></a-box>
<a-text value="Product Service" position="1 1.3 0.5" align="center"
        rotation="-15 30 0" scale="0.5 0.5 0.5"></a-text>

<!-- Order Service -->
<a-box id="orderService" position="2 1 -1" depth="1.2" height="0.4" width="0.6"
       material="color: #D2691E; src: #shippingcontainertexture"
       rotation="15 30 15" service-interaction="name: order-service"></a-box>
<a-text value="Order Service" position="2 -1 -1"
        align= "center"
        rotation="-15 -30 -10"
        scale= "75 .75 .75">
</a-text>

<!-- Payment Service -->
<a-box id="paymentService" position="2 -1 0" depth="1.2" height="0.4" width="0.6"
       material="color: #D2691E; src: #shippingcontainertexture"
       rotation="15 30 15" service-interaction="name: payment-service"></a-box>
<a-text value="Payment Service" position="2 -0.7 0.5" align="center" rotation="-15 30 0" scale="0.5 0.5 0.5"></a-text>

<!-- External Payment Provider -->
<a-box id="external-payment" position="2 -2 0" depth="1.2" height="0.4" width="0.6"
       material="color: #D2691E; src: #shippingcontainertexture"
       rotation="15 30 15" service-interaction="name: external-payment"></a-box>
<a-text value="External Payment Provider" position="2 -1.7 0.5" align="center" rotation="-15 30 0" scale="0.5 0.5 0.5"></a-text>
     
    <!-- Databases -->
<!-- User Database -->
<a-cylinder position="-3 -1 0" radius="0.75" height="1" color="#ADD8E6" service-interaction="name: user-db"></a-cylinder>
<a-text value="User Database" position="-3 -0.365 0" align="center" scale=".5 .75 .5"></a-text>

<!-- Product Database -->
<a-cylinder position="-1 -1 0" radius="0.75" height="1" color="#87CEEB" service-interaction="name: product-db"></a-cylinder>
<a-text value="Product Database" position="-1 -0.365 0" align="center" scale=".5 .75 .5"></a-text>

<!-- Order Database -->
<a-cylinder position="1 -1 0" radius="0.75" height="1" color="#4682B4" service-interaction="name: order-db"></a-cylinder>
<a-text value="Order Database" position="1 -0.365 0"
align= "center" scale= ".5 .75 .5"></a-text>
    </a-entity>

     <!-- Start Button -->
<a-entity id="startButton" 
    geometry="primitive: plane; width: 2; height: 1"
    material="color: #ADFF2F"
    position="-4 0.5 -2"
    text="value: START DATA FLOW; align: center; width: 4"
    start-button>
</a-entity>

<!-- Pause Button -->
<a-entity id="pauseButton" 
    geometry="primitive: plane; width: 2; height: 1"
    material="color: #FF8C00"
    position="4 0.5 -2"
    text="value: PAUSE; align: center; width: 4"
    pause-button>
</a-entity>

<!-- Info Panel -->
<a-entity id="infoPanel"
    geometry="primitive: plane; width: 6; height: 3"
    material="color: #FF4500"
    position="0 -1 -3"
    text="value: DATA BOX; align: center; width: 5; color: black">
</a-entity>

      <a-camera position="0 1.6 0" rotation="3.1412 -10 0">
        <a-cursor></a-cursor>
      </a-camera>
    </a-scene>
  </body>
</html>
